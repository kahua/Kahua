;; This document is written in WiLiKi format.
;; See: http://practical-scheme.net/wiliki/wiliki.cgi?WiLiKi&l=en
;;
;; $Id: INSTALL,v 1.6 2006/09/07 14:16:31 bizenn Exp $

* Setup Kahua

** Preparation

*** Installing Gauche

To use Kahua, you need Gauche 0.8.7 or later that supports pthread.
CVS-HEAD version is recomended because critical bug was fixed.

$ gosh -V
Gauche scheme interpreter, version 0.8.7 [utf-8,pthreads]

If you have not installed proper version of Gauche, please install new
version.

----
** Let's just try Kahua

*** Building tarball

If you just simply try Kahua, installing under HOME directroy is
recommended.  The reason is that you don't need to care about
permissions and user/group settings.

{{{
% tar xvzf Kahua-0.6.tgz
% cd Kahua-0.6
% ./configure --prefix=$HOME/kahua --with-staticdir=$HOME/public_html/kahua
% make
% make check
% make install
% make install-examples
}}}

This will build from the source code and install it under the
${HOME}/kahua and $HOME/public_html/kahua directory.  It will help you
to add ${HOME}/kahua/bin directory to your PATH.

*** Start Kahua

After having installed, you can easily try by running the standalone server: 

% ($HOME/kahua/bin/kahua-spvr --httpd localhost:8888 >>/tmp/kahua-error.log &)

You can set any port number except privileged port.
If you appoint only port number, you can bind server socket to 0.0.0.0(or[::]).

Then, start a browser and visit http://localhost:8888/.
You will see and use  one of sample application,"lambdabooks".


----
----
* Proper Installation procedure

** Short Summary

{{{
% ./configure --with-cgidir=$(KAHUA_CGIDIR) \
  	      --with-cgilogdir=$(KAHUA_CGILOGDIR) \
 	      --with-staticdir=$(KAHUA_STATICDIR)
% make
% make check
% su
# make install
# vi $(CONFFILE)
# chgrp -R $(KAHUA_GROUP) $(KAHUA_DIRS) $(KAHUA_CGILOGDIR)
# chmod -R g+ws $(KAHUA_DIRS)
# chmod 755 $(KAHUA_CGILOGDIR)
# exit
% make install-examples
% vi $(KAHUA_WORK_DIR)/app-servers
% (kahua-spvr > /dev/null 2>&1) &
}}}

You have to have $(KAHUA_GROUP) in /etc/group and the user id which will
run kahua.cgi have to be include in the line.

** Step by step

----
*** [Step 1] Configuration and make

{{{
% ./configure --with-cgidir=$(KAHUA_CGIDIR) \
  	      --with-cgilogdir=$(KAHUA_CGILOGDIR) \
 	      --with-staticdir=$(KAHUA_STATICDIR)
% make
}}}

You need to give a directory name where cgi scripts should be installed
by --with-cgidir option.  If the option is omitted, $prefix/libexec/kahua
is used.  But it should differ by your httpd settings, so make sure
your httpd recognizes the files under that directory as cgi scripts.

Optionally, you can give --with-cgidir=no (or --without-cgidir) to
prevent 'make' from installing cgi scripts automatically.  In such
a case, you need to copy scripts under cgi/ manually to the
desired location.

You need to give also a directory name where cgi scripts should log 
by --with-cgilogdir option.  If the option is omitted, 
$prefix/var/kahua/cgilog is used. 

If you want to use FastCGI, you should specify --with-fastcgi option.
This option makes kahua.fcg script as well as kahua.cgi.

You need to give also a directory name where static document files should be
installed by --with-staticdir option.  If the option is omitted, 
/var/www/kahua is used. 

You can run a self test by 'make check'.

  % make check


----
*** [Step 2] Installation

Installation process writes to several locations.   You have to
have permissions to do so.

{{{
  $(prefix)/tmp/kahua    : This directory is created for Unix domain sockets
                           kahua servers will use.  You can specify it
                           in the kahua.conf file which by default installed
                           in $(sysconfdir)/kahua
  $(localstatedir)/kahua : This directory is created for kahua to save various
                           informations, including database.
  $(KAHUA_CGIDIR)        : CGI scripts will be copied to the directory
                           given to --with-cgidir configure option.
  $(KAHUA_STATICDIR)     : Static document files will be copied to the directory
                           given to --with-staticdir configure option.
  $(sysconfdir)/kahua    : kahua.conf will be copied in this location.
  $(bindir)/kahua        : Kahua commands (shell scripts) will be copied to
                           this location.
  $(libexecdir)/kahua    : Kahua executables called by kahua commands will be
                           copied to this location.
  $(libdir)/kahua        : Kahua modules will be copied to this location.
}}}

"make install" will do the job.


----
*** [Step 3] Setting up

Check the file $(sysconfdir)/kahua.conf and edit it if necessary.

During its normal operation, the Kahua system needs to write
to the following directories:

- socket directory (specified by :sockbase in kahua.conf;
  the default is $(prefix)/tmp/kahua)

- working directory (specified by :working-directory
  in kahua.conf; the default is $(localstatedir)/kahua)

- document directory (specified by :static-document-path
  in kahua.conf; the default is /var/www/kahua)
  This directory is not created by 'make install'.
  You need to make sure creating this directory.

The write permissions of these directories should be open
to the user/group who runs Kahua servers.  One strategy is
to create a group 'kahua' and chgrp those directories,
then put the users that adminsters Kahua servers to the
group.

And the write permissions of the directory where kahua.cgi logs
should be open group who runs kahua.cgi.  One strategy is
to make user that runs kahua.cgi belong the kahua group and chgrp
the directory.


----
*** [Step 4] Running Examples

Run "make install-examples" to install an example application
servers, "lambdabooks", "wiki-iki", "login", "nqueen" "lazy-nqueen", and
"lambdacalcul".

{{{
% make install-examples
}}}

Check $(localstatedir)/kahua/app-servers file and make sure
it contains the following line.  By default, unless you have
already created app-servers file, "make install-examples"
copies a sample app-servers file that contains the following
entry.

{{{
(
  (lambdabooks   :arguments () :run-by-default 1)
  (wiki-iki      :arguments () :run-by-default 1)
  (login         :arguments () :run-by-default 1)
)
}}}

And run Kahua main server.

{{{
% (kahua-spvr > /dev/null 2>&1) &
}}}

You can access the site via kahua-elua.cgi CGI script from
your browser, for example, by specifying kahua.cgi/lambdabooks as URI
to connect to the demo server.

