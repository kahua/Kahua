package	          = kahua
SHELL             = @SHELL@
prefix            = @prefix@
exec_prefix       = @exec_prefix@
bindir            = @bindir@/$(package)
sbindir           = @sbindir@/$(package)
libexecdir	  = @libexecdir@/$(package)
datadir		  = @datadir@/$(package)
sysconfdir        = @sysconfdir@/$(package)
sharedstatedir    = @sharedstatedir@/$(package)
localstatedir     = @localstatedir@/$(package)
libdir            = @libdir@/$(package)
includedir        = @includedir@/$(package)
oldincludedir     = @oldincludedir@/$(package)
infodir           = @infodir@/$(package)
mandir            = @mandir@/$(package)
srcdir            = @srcdir@
VPATH             = $(srcdir)
top_builddir      = @top_builddir@
top_srcdir        = @top_srcdir@

DESTDIR           =

GOSH                   = @GOSH@
GAUCHE_CONFIG          = @GAUCHE_CONFIG@
INSTALL                = @GAUCHE_INSTALL@
INSTALL_TYPE           = @INSTALL_TYPE@
SCM_INSTALL_DIR        = $(libdir)
SCRIPT_INSTALL_DIR     = $(bindir)
KAHUA_STATICDIR        = @KAHUA_STATICDIR@
SOCKET_BASE_DIR        = $(prefix)/tmp/$(package)
TMP_BASE_DIR           = $(localstatedir)/tmp
KAHUA_VERSION          = $(shell cat $(top_srcdir)/VERSION)

MAKE_SH_SCRIPT   = $(GOSH) $(top_srcdir)/src/make-script.scm "$(GOSH)" "$(libdir)"

INSTALL_DIRS = $(SCRIPT_INSTALL_DIR) \
	       $(SCM_SCRIPT_INSTALL_DIR) \
               $(SCM_INSTALL_DIR) \
               $(SCM_INSTALL_DIR)/kahua \
	       $(SCM_INSTALL_DIR)/kahua/test \
               $(SCM_INSTALL_DIR)/kahua/pdf

TESTENV_DIR  = $(top_builddir)/tmp

SH_SCRIPTS  = kahua-spvr    \
              kahua-admin   \
              kahua-install \
              kahua-shell

SCM_SCRIPTS  = kahua-spvr.scm    \
               kahua-admin.scm   \
               kahua-install.scm \
               kahua-shell.scm   \
               kahua-server.scm  \
               kahua-keyserv.scm

SCMFILES = $(SCM_SCRIPTS) \
           kahua.scm kahua/gsid.scm kahua/persistence.scm kahua/user.scm \
           kahua/config.scm kahua/session.scm kahua/server.scm \
           kahua/developer.scm kahua/partcont.scm kahua/elem.scm \
           kahua/util.scm kahua/test/xml.scm kahua/test/worker.scm \
           kahua/sandbox.scm kahua/plugin.scm kahua/pdf.scm \
           kahua/pdf/interp.scm kahua/pdf/main.scm kahua/pdf/monad.scm \
           kahua/pdf/srfi-48-draft.scm  kahua/pdf/srfi-48.scm \
           kahua/pdf/state.scm kahua/pdf/typeset.scm kahua/pdf/util.scm \
           kahua/error-report.scm

CONFFILE = $(sysconfdir)/kahua.conf
USERCONFFILE = $(localstatedir)/user.conf

GENERATED = $(SH_SCRIPTS) kahua.conf test.conf \
            kahua/config.scm kahua.conf

CONFIG_GENERATED = Makefile 
.PHONY: all check testenv clean distclean install maintainer-clean

all: $(GENERATED)

$(SH_SCRIPTS) : make-script.scm

kahua-admin :
	$(MAKE_SH_SCRIPT) kahua-admin

kahua-spvr :
	$(MAKE_SH_SCRIPT) kahua-spvr

kahua-install :
	$(MAKE_SH_SCRIPT) kahua-install

kahua-shell :
	$(MAKE_SH_SCRIPT) kahua-shell


kahua/config.scm: kahua/config.scm.in
	test ! -f $@ || chmod +w $@
	sed -e "s@##sysconfdir##@$(sysconfdir)@" \
	    -e "s@##localstatedir##@$(localstatedir)@" \
	    -e "s@##SOCKET_BASE_DIR##@$(SOCKET_BASE_DIR)@" \
	    -e "s@##KAHUA_STATICDIR##@$(KAHUA_STATICDIR)@" \
	    -e "s@##package##@$(package)@" \
	    -e "s@##KAHUA_VERSION##@$(KAHUA_VERSION)@" \
            $@.in > $@
	chmod -w $@

kahua.conf: kahua.conf.sample
	test ! -f $@ || chmod +w $@
	sed -e "s@##SOCKET_BASE_DIR##@$(SOCKET_BASE_DIR)@" \
            -e "s@##localstatedir##@$(localstatedir)@" \
            -e "s@##KAHUA_STATICDIR##@$(KAHUA_STATICDIR)@" \
            kahua.conf.sample > $@
	chmod -w $@

test.conf : make-testconf.scm
	$(GOSH) ./make-testconf.scm $(top_builddir) $(top_srcdir)

check:

# cleanup
clean:
	rm -rf core *~ kahua/*~ $(GENERATED)
	rm -rf $(TESTENV_DIR)

# installation
# NB: libexecdir is created for backward compatibility.  Eventually
# we'll remove it.
install: all
	$(INSTALL) -m 770 -d $(SOCKET_BASE_DIR) $(sysconfdir) $(localstatedir) $(libexecdir) $(TMP_BASE_DIR)
	$(INSTALL) -m 444 -T $(SCM_INSTALL_DIR) -S $(srcdir) $(SCMFILES)
	$(INSTALL) -m 555 -T $(SCRIPT_INSTALL_DIR) $(SH_SCRIPTS)
	@if test ! -f $(sysconfdir)/kahua.conf; then \
	  $(INSTALL) -m 444 kahua.conf $(sysconfdir)/kahua.conf; \
	fi
	@if test ! -f $(localstatedir)/user.conf; then \
	  $(INSTALL) -m 644 user.conf.sample $(localstatedir)/user.conf; \
	fi

uninstall:
	@for f in $(SCMFILES); do \
	  rm -f $(SCM_INSTALL_DIR)/$$f; \
	done
	@for f in $(SH_SCRIPTS); do \
	  rm -f $(SCRIPT_INSTALL_DIR)/$$f; \
	done

distclean: clean
	rm -rf $(CONFIG_GENERATED)

maintainer-clean: clean
	rm -rf $(CONFIG_GENERATED)


