SHELL       = @SHELL@
prefix      = @prefix@
exec_prefix = @exec_prefix@
bindir      = @bindir@
libdir      = @libdir@
srcdir      = @srcdir@
VPATH       = $(srcdir)
top_builddir = @top_builddir@
top_srcdir   = @top_srcdir@

DESTDIR  =

GOSH = @GOSH@
GAUCHE_CONFIG = @GAUCHE_CONFIG@
INSTALL = @INSTALL@
INSTALL_TYPE = @INSTALL_TYPE@
MKINSTDIR = $(top_srcdir)/mkinstalldirs
SCM_INSTALL_DIR = $(DESTDIR)`$(GAUCHE_CONFIG) --$(INSTALL_TYPE)libdir`
SCRIPT_INSTALL_DIR = $(bindir)

INSTALL_DIRS = $(SCRIPT_INSTALL_DIR) $(SCM_INSTALL_DIR)/kahua/test
CREATE_DIRS = /var/lib/kahua /var/lib/kahua/user \
              /tmp/kahua /tmp/kahua/user

SCRIPTS  = kahua-spvr kahua-server kahua-admin kahua-install kahua-shell
SCMFILES = kahua.scm kahua/gsid.scm kahua/persistence.scm kahua/user.scm \
           kahua/config.scm kahua/session.scm kahua/server.scm \
           kahua/developer.scm kahua/partcont.scm kahua/elem.scm \
           kahua/util.scm kahua/test/xml.scm kahua/test/worker.scm \
           kahua/sandbox.scm kahua/plugin.scm
CONFFILE = /etc/kahua.conf
USERCONFFILE = /var/lib/kahua/user.conf

CONFIG_GENERATED = Makefile 
.PHONY: all check clean distclean install maintainer-clean

.SUFFIXES: .in

.in:
	$(top_srcdir)/src/fix-shebang.sh "$(GOSH)" $@

all: $(SCRIPTS)


check:

clean:
	rm -rf core *~ kahua/*~ $(SCRIPTS)

install: all
	$(MKINSTDIR) $(INSTALL_DIRS) $(CREATE_DIRS)
	@for f in $(SCMFILES); do \
	  $(INSTALL) -m 444 $$f $(SCM_INSTALL_DIR)/$$f; \
	done
	@for f in $(SCRIPTS); do \
	  $(INSTALL) -m 555 $$f $(SCRIPT_INSTALL_DIR)/$$f; \
	done
	@if test ! -f $(CONFFILE); then \
	  $(INSTALL) -m 444 kahua.conf.sample $(CONFFILE); \
	fi
	@if test ! -f $(USERCONFFILE); then \
	  $(INSTALL) -m 644 user.conf.sample $(USERCONFFILE); \
	fi

uninstall:
	@for f in $(SCMFILES); do \
	  rm -f $(SCM_INSTALL_DIR)/$$f; \
	done
	@for f in $(SCRIPTS); do \
	  rm -f $(SCRIPT_INSTALL_DIR)/$$f; \
	done

distclean: clean
	rm -rf $(CONFIG_GENERATED)

maintainer-clean: clean
	rm -rf $(CONFIG_GENERATED)


