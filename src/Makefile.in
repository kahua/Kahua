package	          = kahua
SHELL             = @SHELL@
prefix            = @prefix@
exec_prefix       = @exec_prefix@
bindir            = @bindir@/$(package)
sbindir           = @sbindir@/$(package)
libexecdir	  = @libexecdir@/$(package)
datadir		  = @datadir@/$(package)
sysconfdir        = @sysconfdir@/$(package)
sharedstatedir    = @sharedstatedir@/$(package)
localstatedir     = @localstatedir@/$(package)
libdir            = @libdir@/$(package)
includedir        = @includedir@/$(package)
oldincludedir     = @oldincludedir@/$(package)
infodir           = @infodir@/$(package)
mandir            = @mandir@/$(package)
srcdir            = @srcdir@
VPATH             = $(srcdir)
top_builddir      = @top_builddir@
top_srcdir        = @top_srcdir@

DESTDIR           =

GOSH                   = @GOSH@
GAUCHE_CONFIG          = @GAUCHE_CONFIG@
INSTALL                = @INSTALL@
INSTALL_TYPE           = @INSTALL_TYPE@
MKINSTDIR              = $(top_srcdir)/mkinstalldirs
SCM_INSTALL_DIR        = $(libdir)
SCRIPT_INSTALL_DIR     = $(bindir)
SCM_SCRIPT_INSTALL_DIR = $(libexecdir)
SOCKET_BASE_DIR        = $(prefix)/tmp/$(package)

INSTALL_DIRS = $(SCRIPT_INSTALL_DIR) \
	       $(SCM_SCRIPT_INSTALL_DIR) \
               $(SCM_INSTALL_DIR) \
               $(SCM_INSTALL_DIR)/kahua \
	       $(SCM_INSTALL_DIR)/kahua/test \
               $(SCM_INSTALL_DIR)/kahua/pdf

SCRIPTS  = kahua-spvr.sh    \
           kahua-admin.sh   \
           kahua-install.sh \
           kahua-shell.sh

SVR_SCRIPTS = kahua-server.sh \
	      kahua-keyserv.sh

SCM_SCRIPTS  = kahua-spvr    \
               kahua-admin   \
               kahua-install \
               kahua-shell

SCM_SVR_SCRIPTS = kahua-server \
		  kahua-keyserv

SCMFILES = kahua.scm kahua/gsid.scm kahua/persistence.scm kahua/user.scm \
           kahua/config.scm kahua/session.scm kahua/server.scm \
           kahua/developer.scm kahua/partcont.scm kahua/elem.scm \
           kahua/util.scm kahua/test/xml.scm kahua/test/worker.scm \
           kahua/sandbox.scm kahua/plugin.scm kahua/pdf.scm \
           kahua/pdf/interp.scm kahua/pdf/main.scm kahua/pdf/monad.scm \
           kahua/pdf/srfi-48-draft.scm  kahua/pdf/srfi-48.scm \
           kahua/pdf/state.scm kahua/pdf/typeset.scm kahua/pdf/util.scm

CONFFILE = $(sysconfdir)/kahua.conf
USERCONFFILE = $(localstatedir)/user.conf

CONFIG_GENERATED = Makefile 
.PHONY: all check clean distclean install maintainer-clean

.SUFFIXES: # Delete the default suffixes to kill the malicious .sh rule
.SUFFIXES: .in

.in:
	$(top_srcdir)/src/fix-shebang.sh "$(GOSH)" "$(libdir)" "$(libexecdir)" $@

all: $(SCM_SCRIPTS) $(SCM_SVR_SCRIPTS) kahua/config.scm kahua.conf kahua/pdf/typeset.scm

kahua/config.scm: kahua/config.scm.in
	test ! -f $@ || chmod +w $@
	sed -e "s@##sysconfdir##@$(sysconfdir)@" -e "s@##localstatedir##@$(localstatedir)@" -e "s@##SOCKET_BASE_DIR##@$(SOCKET_BASE_DIR)@" -e "s@##package##@$(package)@" $@.in > $@
	chmod -w $@

kahua/pdf/typeset.scm: kahua/pdf/typeset.scm.in
	test ! -f $@ || chmod +w $@
	$(GOSH) cesconv -o kahua/pdf/typeset.scm -f euc-jp kahua/pdf/typeset.scm.in
	chmod -w $@

kahua.conf: kahua.conf.sample
	test ! -f $@ || chmod +w $@
	sed -e "s@##SOCKET_BASE_DIR##@$(SOCKET_BASE_DIR)@" -e "s@##localstatedir##@$(localstatedir)@" kahua.conf.sample > $@
	chmod -w $@

check:

clean:
	rm -rf core *~ kahua/*~ \
	  $(SCRIPTS) $(SCM_SCRIPTS) $(SVR_SCRIPTS) $(SCM_SVR_SCRIPTS) \
	  kahua/config.scm kahua/pdf/typeset.scm kahua.conf

server-scripts	:
	@for f in $(SVR_SCRIPTS); do \
	  sed -e "2s@^/@exec /@" $$f > $$f.svr; \
	done

install: all server-scripts
	$(MKINSTDIR) $(INSTALL_DIRS) $(SOCKET_BASE_DIR) $(sysconfdir) $(localstatedir)
	chmod o-rwx $(SOCKET_BASE_DIR)
	@for f in $(SCMFILES); do \
	  $(INSTALL) -m 444 $$f $(SCM_INSTALL_DIR)/$$f; \
	done
	@for f in $(SCM_SCRIPTS); do \
	  $(INSTALL) -m 555 $$f $(SCM_SCRIPT_INSTALL_DIR)/$$f.scm; \
	done
	@for f in $(SCM_SVR_SCRIPTS); do \
	  $(INSTALL) -m 555 $$f $(SCM_SCRIPT_INSTALL_DIR)/$$f.scm; \
	done
	@for f in $(SCM_SCRIPTS); do \
	  $(INSTALL) -m 555 $$f.sh $(SCRIPT_INSTALL_DIR)/$$f; \
	done
	@for f in $(SCM_SVR_SCRIPTS); do \
	  $(INSTALL) -m 555 $$f.sh.svr $(SCRIPT_INSTALL_DIR)/$$f; \
	done
	@if test ! -f $(CONFFILE); then \
	  $(INSTALL) -m 444 kahua.conf $(CONFFILE); \
	fi
	@if test ! -f $(USERCONFFILE); then \
	  $(INSTALL) -m 644 user.conf.sample $(USERCONFFILE); \
	fi

uninstall:
	@for f in $(SCMFILES); do \
	  rm -f $(SCM_INSTALL_DIR)/$$f; \
	done
	@for f in $(SCRIPTS); do \
	  rm -f $(SCRIPT_INSTALL_DIR)/$$f; \
	done
	@for f in $(SCM_SCRIPTS); do \
	  rm -f $(SCM_SCRIPT_INSTALL_DIR)/$$f; \
	done
	@for f in $(SCM_SVR_SCRIPTS); do \
	  rm -f $(SCM_SCRIPT_INSTALL_DIR)/$$f; \
	done

distclean: clean
	rm -rf $(CONFIG_GENERATED)

maintainer-clean: clean
	rm -rf $(CONFIG_GENERATED)


